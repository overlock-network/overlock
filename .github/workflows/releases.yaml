name: Release builds

on:
  push:
    tags:
    - '*'

permissions:
    contents: write
    packages: write
    
jobs:
  releases-matrix:
    name: Release Go Binary
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # build and publish in parallel: linux/386, linux/amd64, linux/arm64, windows/386, windows/amd64, darwin/amd64, darwin/arm64
        goos: [linux, windows, darwin]
        goarch: ["386", amd64, arm64]
        exclude:
          - goarch: "386"
            goos: darwin
          - goarch: arm64
            goos: windows
          - goarch: "386"
            goos: windows
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set APP_VERSION env
        run: echo APP_VERSION=$(echo ${GITHUB_REF} | rev | cut -d'/' -f 1 | rev ) >> ${GITHUB_ENV}

      - name: Generate Changelog
        id: changelog
        run: |
          CURRENT_TAG=${{ vars.GITHUB_REF_NAME }}
          echo "Current tag: $CURRENT_TAG"

          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || git rev-list --max-parents=0 HEAD)
          echo "Previous tag/commit: $PREVIOUS_TAG"

          CHANGELOG_CONTENT=$(git log --pretty=format:'* %s (%h)' $PREVIOUS_TAG..$CURRENT_TAG)

          {
            echo 'changelog<<EOF'
            echo "$CHANGELOG_CONTENT"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - uses: ncipollo/release-action@v1
        with:
          tag: ${{ vars.GITHUB_REF_NAME }}
          skipIfReleaseExists: true
          body: |
            ## Changelog
            ${{ steps.changelog.outputs.changelog }}

      - uses: wangyoucao577/go-release-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          goos: ${{ matrix.goos }}
          goarch: ${{ matrix.goarch }}
          project_path: "./cmd/overlock"
          binary_name: "overlock"
          ldflags: -X "github.com/web-seven/overlock/cmd/overlock/version.Version=${{ env.APP_VERSION }}"

      - name: Notify Discord
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_RELEASE_WEBHOOK }}
        run: |
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${{ vars.GITHUB_REF_NAME }}"
          curl -H "Content-Type: application/json" \
            -X POST \
            -d @- $DISCORD_WEBHOOK <<EOF
          {
            "content": "ðŸš€ New release [${{ vars.GITHUB_REF_NAME }}]($RELEASE_URL)"
          }
          EOF
